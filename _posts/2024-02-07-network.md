---
layout: post
title: network
date: 2024-02-07 07:43 -0800
categories: [network]
tags: [network, tcpdump]
---

# Network tools

## Tcpdump

Tcpdump, as said on its [front page](https://www.tcpdump.org/index.html), has
two products:

- tcpdump: command line tool
- libpcap: C library for network traffic capture.

### libpcap

The [document](https://www.tcpdump.org/manpages/pcap.3pcap.html) is very short.
I spend 10 min going through it and can understand how to use it.

Gopacket is golang wrapper on top of it.

### tcpdump tricks

There are many articles online explain the meaning of each field in the output
of tcpdump. My favorite resource is TCP Wikipedia.

Popular options:

- `-X`: print out both ASCII and hex text.
- `-i`: specify the interface
- `-e`: print out MAC address.

Note, tcpdump 4.99 also prints out interface name. See
[post](https://serverfault.com/a/1054024).

Examples:

```bash
# capture TCP traffic on port 8000 and print out the content in ASCII
tcpdump -i any tcp and port 8000 -A

# Filter by the last four bytes of tcp packaet to be `}}\r\n`
# ip[2:2] gets the length of the ip packet. Here we assume it is ipv4.
# In ipv4's header, the 3rd and 4th bytes denotes the total length of the
# ip packet. TCP body is the last part of an IP packet. So in this way, we
# can filter the last bytes of a TCP packet.
tcpdump -i eth0 'tcp and ip[ip[2:2]-4:4] = 0x7d7d0d0a)'


# Use complicated logical operation.
# Note: in order to not get splitted by shell, the long filter is put inside
# a single quote.
tcpdump -i eth0 'tcp and (src host redis-master-0.redis-headless.production.svc.cluster.local and port 6379 and tcp[32:2] = 0x2a32 and ip[ip[2:2]-4:2] = 0x7d7d) or (dst port 6379 and (tcp[55:4] = 0x5a414444 or tcp[55:4] = 0x5a52454d)) -X'
```

For TCP, libpcap captures each individual tcp segment. So the question is how
we can reassemble relevant segments into a whole request. There are many
implementations online. Such as
[goreplay](https://github.com/dingxiong/goreplay/blob/e74e945e7f8c3bab852ef21bad0d67b3fa94f7e5/tcp/doc.go#L3),
[Akita Cli](https://github.com/dingxiong/goreplay/blob/e74e945e7f8c3bab852ef21bad0d67b3fa94f7e5/tcp/doc.go#L3).

### Redis support
